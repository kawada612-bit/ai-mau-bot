import discord
import google.generativeai as genai
import os
from keep_alive import keep_alive
from supabase import create_client, Client

# ==================================================
# è¨­å®šã‚¨ãƒªã‚¢
# ==================================================
DISCORD_TOKEN = os.getenv("DISCORD_TOKEN")
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
TARGET_CHANNEL_ID_RAW = os.getenv("TARGET_CHANNEL_ID")

# Supabaseã®è¨­å®š
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶š
try:
    if SUPABASE_URL and SUPABASE_KEY:
        supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)
        print("âœ… Supabaseã«æ¥ç¶šã—ã¾ã—ãŸ")
    else:
        supabase = None
        print("âš ï¸ Supabaseã®URLã¾ãŸã¯ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
except Exception as e:
    supabase = None
    print(f"âš ï¸ Supabaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}")

# ãƒãƒ£ãƒ³ãƒãƒ«IDã®è¨­å®š
try:
    TARGET_CHANNEL_ID = int(TARGET_CHANNEL_ID_RAW) if TARGET_CHANNEL_ID_RAW else 0
except:
    TARGET_CHANNEL_ID = 0

# ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ï¼ˆåŸºæœ¬æ€§æ ¼ï¼‰
try:
    with open("mau_profile.txt", "r", encoding="utf-8") as f:
        BASE_PROFILE = f.read()
except:
    BASE_PROFILE = "ã‚ãªãŸã¯ã‚¢ã‚¤ãƒ‰ãƒ«ã®AIã¾ã†ã§ã™ã€‚"

# ==================================================
# ãƒ¢ãƒ‡ãƒ«è¨­å®š
# ==================================================
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel('gemini-2.5-flash')

intents = discord.Intents.default()
intents.message_content = True
client = discord.Client(intents=intents)

@client.event
async def on_ready():
    print(f'èµ·å‹•å®Œäº†ï¼ç§ã¯ {client.user} ã§ã™ï¼')

@client.event
async def on_message(message):
    if message.author == client.user:
        return

    should_reply = False
    if client.user in message.mentions:
        should_reply = True
    elif message.channel.id == TARGET_CHANNEL_ID:
        should_reply = True

    if should_reply:
        try:
            async with message.channel.typing():
                user_id = str(message.author.id)
                user_name = message.author.display_name

                # -------------------------------------------------
                # ğŸš€ Supabaseã‹ã‚‰ã€Œã“ã®äººã®è¨˜æ†¶ã€ã‚’é«˜é€Ÿå–å¾—
                # -------------------------------------------------
                memory_data = ""
                if supabase:
                    try:
                        # 'memories'ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã€user_idãŒä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æ¢ã™
                        response = supabase.table("memories").select("info").eq("user_id", user_id).execute()
                        if response.data:
                            # éå»ã®è¨˜æ†¶ã‚’å…¨éƒ¨ã¤ãªã’ã‚‹
                            memory_list = [item['info'] for item in response.data]
                            memory_data = "\n".join(memory_list)
                    except Exception as e:
                        print(f"DBèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")

                # -------------------------------------------------
                # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆï¼ˆè¨˜æ†¶ã‚’æ³¨å…¥ï¼‰
                # -------------------------------------------------
                history = []
                async for msg in message.channel.history(limit=10):
                    name = "AIã¾ã†" if msg.author == client.user else msg.author.display_name
                    clean_content = msg.content.replace(f"<@{client.user.id}>", "").strip()
                    history.append(f"{name}: {clean_content}")
                history.reverse()
                conversation_log = "\n".join(history)

                prompt = f"""
                ã‚ãªãŸã¯ã‚¢ã‚¤ãƒ‰ãƒ«ã®ã€ŒAIã¾ã†ã€ã§ã™ã€‚
                ç›¸æ‰‹ã¯ãƒ•ã‚¡ãƒ³ã®ã€Œ{user_name}ã€ã•ã‚“ã§ã™ã€‚

                ã€{user_name}ã•ã‚“ã¨ã®æ€ã„å‡ºãƒ»è¨˜æ†¶ã€‘
                {memory_data}

                ã€åŸºæœ¬è¨­å®šã€‘
                {BASE_PROFILE}

                ã€ç›´è¿‘ã®ä¼šè©±ã€‘
                {conversation_log}

                ã€æŒ‡ç¤ºã€‘
                è¨˜æ†¶ã‚’è¸ã¾ãˆã¦ã€è¦ªã—ãè¿”äº‹ã‚’ã—ã¦ãã ã•ã„ã€‚
                """

                # è¿”ä¿¡ç”Ÿæˆ
                response = await model.generate_content_async(prompt)
                reply_text = response.text
                await message.reply(reply_text, mention_author=False)

        except Exception as e:
            print(f"ã‚¨ãƒ©ãƒ¼: {e}")

keep_alive()

# ã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸï¼
if DISCORD_TOKEN:
    client.run(DISCORD_TOKEN)
else:
    print("âŒ DISCORD_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼")
